{"body":"# FormKit Ninja Upstream Changes Required\n\nThis document outlines the changes needed in the `formkit_ninja` package to support the enhanced frontend editor features.\n\n## Overview\n\nThe frontend editor enhancements require additional properties and capabilities in the `FormKitNodeIn` schema and related backend models. This document provides detailed specifications for upstream changes.\n\n## Change 1: Enhanced Repeater Support\n\n### Background\nCurrently, the editor can create basic repeaters, but lacks support for advanced repeater configuration properties used in existing schemas.\n\n### Required Changes\n\n#### 1.1 Update `FormKitNodeIn` Schema\n\nAdd the following optional properties to support repeater configuration:\n\n```python\nclass FormKitNodeIn(BaseModel):\n    # ... existing properties ...\n    \n    # Repeater-specific properties\n    min: Optional[int] = None\n    max: Optional[int] = None\n    addLabel: Optional[str] = None\n    itemClass: Optional[str] = None\n    itemsClass: Optional[str] = None\n    upControl: Optional[bool] = None\n    downControl: Optional[bool] = None\n    validationRules: Optional[str] = None\n```\n\n#### 1.2 Update Node Model\n\nEnsure the `FormKitSchemaNode` model can store and retrieve these properties:\n\n```python\n# In formkit_ninja/models.py\nclass FormKitSchemaNode(models.Model):\n    # ... existing fields ...\n    \n    # These properties should be stored in the node JSON field\n    # The node JSON should support:\n    # {\n    #   \"$formkit\": \"repeater\",\n    #   \"name\": \"repeaterName\",\n    #   \"min\": 1,\n    #   \"max\": 10,\n    #   \"addLabel\": \"Add another item\",\n    #   \"itemClass\": \"custom-class\",\n    #   \"itemsClass\": \"items-class\",\n    #   \"upControl\": False,\n    #   \"downControl\": False,\n    #   \"validationRules\": \"validateRepeaterItem\"\n    # }\n```\n\n#### 1.3 Validation\n\nAdd validation to ensure:\n- `min >= 0`\n- `max >= min` (if both are provided)\n- `validationRules` references valid validation functions\n\n### Example Schema\n\n```json\n{\n  \"$formkit\": \"repeater\",\n  \"name\": \"projectTeam\",\n  \"min\": 1,\n  \"max\": 3,\n  \"addLabel\": \"$gettext('Add another member')\",\n  \"itemClass\": \"repeater-children-index\",\n  \"itemsClass\": \"repeater\",\n  \"upControl\": false,\n  \"downControl\": false,\n  \"validationRules\": \"validateProjectMember\",\n  \"children\": [\n    {\n      \"$formkit\": \"text\",\n      \"name\": \"memberName\",\n      \"label\": \"$gettext('Name')\"\n    }\n  ]\n}\n```\n\n---\n\n## Change 2: Conditional Logic Support\n\n### Background\nMany schemas use `if:` statements for conditional field display. The editor needs to create and edit these conditions through the UI.\n\n### Required Changes\n\n#### 2.1 Update `FormKitNodeIn` Schema\n\nAdd support for conditional logic:\n\n```python\nclass FormKitNodeIn(BaseModel):\n    # ... existing properties ...\n    \n    # Conditional logic\n    if: Optional[str] = None  # FormKit conditional expression string\n```\n\n#### 2.2 Validation\n\nValidate that `if:` expressions are syntactically correct:\n- Support `$get(fieldName).value` syntax\n- Support comparison operators (`===`, `!==`, `>`, `<`, `>=`, `<=`)\n- Support logical operators (`&&`, `||`)\n- Support function calls (e.g., `$ida(group).length`)\n\n#### 2.3 Backend Processing\n\nEnsure the backend:\n- Stores `if:` property in node JSON\n- Validates that referenced fields exist in the schema\n- Allows nested conditions\n\n### Example Schema\n\n```json\n{\n  \"$formkit\": \"select\",\n  \"name\": \"subsector\",\n  \"if\": \"$get(sector).value && $ida(subsector, \\\"sector_id=\\\"+$get(sector).value).length\",\n  \"options\": \"$ida(subsector, \\\"sector_id=\\\"+$get(sector).value)\",\n  \"label\": \"$gettext('Subsector')\"\n}\n```\n\n---\n\n## Change 3: Enhanced Options Support\n\n### Background\nThe editor needs to support complex option expressions beyond simple `$ida(groupName)`.\n\n### Required Changes\n\n#### 3.1 Support Complex Option Expressions\n\nThe `options` property should support:\n\n1. **Simple IDA groups**: `\"$ida(sector)\"`\n2. **Filtered IDA groups**: `\"$ida(subsector, \\\"sector_id=1\\\")\"`\n3. **Dynamic filters**: `\"$ida(subsector, \\\"sector_id=\\\"+$get(sector).value)\"`\n4. **Custom functions**: `\"$getLocations($get(district).value, $get(adminPost).value)\"`\n5. **Computed functions**: `\"$getoptions.tf1321.outputs($get(district).value, ...)\"`\n\n#### 3.2 Validation\n\nValidate that:\n- Function names exist in the allowed list\n- Filter expressions are syntactically correct\n- Referenced fields exist in the schema\n\n#### 3.3 Backend Storage\n\nEnsure the backend stores these expressions as strings in the `options` property without modification.\n\n### Example Schemas\n\n```json\n// Simple\n{\n  \"$formkit\": \"select\",\n  \"options\": \"$ida(sector)\"\n}\n\n// Filtered\n{\n  \"$formkit\": \"select\",\n  \"options\": \"$ida(subsector, \\\"sector_id=1\\\")\"\n}\n\n// Dynamic\n{\n  \"$formkit\": \"select\",\n  \"options\": \"$ida(subsector, \\\"sector_id=\\\"+$get(sector).value)\"\n}\n\n// Custom function\n{\n  \"$formkit\": \"select\",\n  \"options\": \"$getLocations($get(district).value, $get(administrative_post).value)\"\n}\n```\n\n---\n\n## Change 4: Custom Validation Rules\n\n### Background\nRepeaters and some fields use custom validation rules (e.g., `validateProjectMember`). The editor needs to create fields with these rules.\n\n### Required Changes\n\n#### 4.1 Update `FormKitNodeIn` Schema\n\n```python\nclass FormKitNodeIn(BaseModel):\n    # ... existing properties ...\n    \n    # Custom validation rules (already partially supported)\n    validationRules: Optional[str] = None  # Name of validation function\n    validation: Optional[Union[str, List[str]]] = None  # Standard validation rules\n```\n\n#### 4.2 Validation Function Registry\n\nCreate or document a registry of available validation functions:\n\n- Built-in: `required`, `email`, `number`, `length`, etc.\n- Custom: `validateProjectMember`, `validatePlanningMember`, etc.\n\n#### 4.3 Validation\n\nEnsure that:\n- `validationRules` references valid functions\n- Standard `validation` rules are syntactically correct\n- Custom validation functions are available at runtime\n\n### Example Schema\n\n```json\n{\n  \"$formkit\": \"repeater\",\n  \"name\": \"projectTeam\",\n  \"validationRules\": \"validateProjectMember\",\n  \"children\": [...]\n}\n```\n\n---\n\n## Change 5: Field Constraints\n\n### Background\nFields need various constraints (min/max for numbers, maxLength for text, date constraints for datepickers).\n\n### Required Changes\n\n#### 5.1 Update `FormKitNodeIn` Schema\n\n```python\nclass FormKitNodeIn(BaseModel):\n    # ... existing properties ...\n    \n    # Constraints (some already exist)\n    min: Optional[Union[int, str]] = None  # For numbers or date sources\n    max: Optional[Union[int, str]] = None  # For numbers or date sources\n    maxLength: Optional[int] = None  # For text fields\n    _minDateSource: Optional[str] = None  # For datepickers\n    _maxDateSource: Optional[str] = None  # For datepickers\n    disabledDays: Optional[str] = None  # Function reference for datepickers\n```\n\n#### 5.2 Validation\n\nValidate constraints are appropriate for field types:\n- Numbers: `min` and `max` must be numeric\n- Text: `maxLength` must be positive integer\n- Datepickers: `_minDateSource` and `_maxDateSource` must reference valid fields\n- Datepickers: `disabledDays` must reference valid function\n\n### Example Schemas\n\n```json\n// Number constraints\n{\n  \"$formkit\": \"number\",\n  \"name\": \"quantity\",\n  \"min\": 0,\n  \"max\": 100,\n  \"validation\": \"shouldNotAcceptNegativeValue\"\n}\n\n// Text constraints\n{\n  \"$formkit\": \"tel\",\n  \"name\": \"phone\",\n  \"maxLength\": 8,\n  \"validation\": \"number|length:8,8\"\n}\n\n// Datepicker constraints\n{\n  \"$formkit\": \"datepicker\",\n  \"name\": \"endDate\",\n  \"_minDateSource\": \"startDate\",\n  \"label\": \"$gettext('End date')\"\n}\n```\n\n---\n\n## Change 6: API Enhancements\n\n### Background\nThe API should provide better validation and error messages for complex configurations.\n\n### Required Changes\n\n#### 6.1 Enhanced Error Responses\n\nUpdate `FormKitErrors` to include:\n- Field-specific validation errors\n- Conditional expression validation errors\n- Option expression validation errors\n- Constraint validation errors\n\n#### 6.2 Validation Endpoint (Optional)\n\nConsider adding a validation endpoint that can check:\n- Conditional expressions without creating nodes\n- Option expressions\n- Field references\n\n### Example Error Response\n\n```json\n{\n  \"errors\": [],\n  \"field_errors\": {\n    \"if\": [\"Referenced field 'sector' does not exist in parent\"],\n    \"options\": [\"Invalid option expression: syntax error\"],\n    \"min\": [\"min must be less than or equal to max\"]\n  }\n}\n```\n\n---\n\n## Implementation Priority\n\n1. **High Priority**: Changes 1 (Repeater), 2 (Conditional Logic), 3 (Options)\n2. **Medium Priority**: Change 4 (Validation), Change 5 (Constraints)\n3. **Low Priority**: Change 6 (API Enhancements)\n\n## Testing Requirements\n\nFor each change, provide:\n1. Unit tests for schema validation\n2. Integration tests for node creation/update\n3. Tests for backward compatibility\n4. Documentation updates\n\n## Migration Strategy\n\n1. **Backward Compatibility**: All new properties should be optional\n2. **Gradual Rollout**: Support both old and new schemas\n3. **Validation**: Strict validation only for new properties\n\n## Questions for Upstream Team\n\n1. Are there existing plans to support these features?\n2. What is the preferred format for conditional expressions?\n3. How should custom validation functions be registered?\n4. Are there security concerns with dynamic option expressions?\n5. What is the timeline for implementing these changes?\n\n---\n\n## References\n\n- Current `FormKitNodeIn` schema in `formkit_ninja` package\n- Existing schemas in `frontend/_formkit/schema/forms/`\n- Gap analysis: `FRONTEND_EDITOR_GAPS_ANALYSIS.md`\n","title":"Support Enhanced Frontend Editor Features: Repeater, Conditional Logic, Options, Validation"}
